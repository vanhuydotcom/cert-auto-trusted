name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check certificate files
        shell: pwsh
        run: |
          Write-Host "Checking for certificate files..."
          if (-not (Test-Path "certs\cert.pem")) {
            Write-Error "ERROR: certs\cert.pem not found!"
            Write-Host "Please ensure cert.pem is committed to the repository or use secrets."
            exit 1
          }
          Write-Host "âœ“ Found certs\cert.pem"
          
          if (Test-Path "certs\key.pem") {
            Write-Host "âœ“ Found certs\key.pem"
          } else {
            Write-Host "âš  Warning: certs\key.pem not found (optional)"
          }
      
      - name: Install ps2exe
        shell: pwsh
        run: |
          Write-Host "Installing ps2exe module..."
          Install-Module -Name ps2exe -Scope CurrentUser -Force -Verbose
          Write-Host "âœ“ ps2exe installed successfully"
      
      - name: Install Inno Setup
        shell: pwsh
        run: |
          Write-Host "Downloading Inno Setup..."
          $innoUrl = "https://jrsoftware.org/download.php/is.exe"
          $innoInstaller = "$env:TEMP\innosetup.exe"
          
          Invoke-WebRequest -Uri $innoUrl -OutFile $innoInstaller
          
          Write-Host "Installing Inno Setup..."
          Start-Process -FilePath $innoInstaller -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
          
          Write-Host "âœ“ Inno Setup installed successfully"
      
      - name: Build installer
        shell: pwsh
        run: |
          Write-Host "Building installer..."
          .\build.ps1
          
          if (-not (Test-Path "dist\CertAutoTrust-Setup-1.0.0.exe")) {
            Write-Error "Build failed: Installer not found!"
            exit 1
          }
          
          Write-Host "âœ“ Build completed successfully"
      
      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Tag: $tag"
          echo "Version: $version"
      
      - name: Rename installer with version
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $oldName = "dist\CertAutoTrust-Setup-1.0.0.exe"
          $newName = "dist\CertAutoTrust-Setup-$version.exe"
          
          if (Test-Path $oldName) {
            Move-Item -Path $oldName -Destination $newName -Force
            Write-Host "âœ“ Renamed installer to: $newName"
          }
      
      - name: Create Release and Upload Asset
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $tag = "${{ github.ref_name }}"
          $installerPath = "dist\CertAutoTrust-Setup-$version.exe"

          Write-Host "Creating release for tag: $tag"

          # Create release notes
          $releaseNotes = @"
          ## Certificate Auto-Trust Installer $tag

          ### ðŸ“¦ What's Included

          - **CertAutoTrust-Setup-$version.exe** - Windows installer

          ### ðŸš€ Installation

          1. Download ``CertAutoTrust-Setup-$version.exe``
          2. Right-click and select "Run as Administrator"
          3. Follow the installation wizard
          4. Click "Yes" when prompted to install the certificate

          ### âœ¨ Features

          - Automatically installs SSL certificate to Windows Trusted Root CA
          - Eliminates "Your connection is not private" warnings
          - Works with Chrome, Edge, and other browsers using Windows certificate store
          - Simple one-click installation

          ### ðŸ“‹ Requirements

          - Windows 10/11 or Windows Server 2016+
          - Administrator privileges

          ### ðŸ”’ Security Note

          This installer contains the certificate and private key. Only install if you trust the source.

          ---

          **Built automatically by GitHub Actions**
          "@

          # Save release notes to file
          $releaseNotes | Out-File -FilePath "release-notes.md" -Encoding UTF8

          # Create release with GitHub CLI
          gh release create "$tag" `
            --title "Release $tag" `
            --notes-file "release-notes.md" `
            "$installerPath"

          Write-Host "âœ“ Release created and installer uploaded successfully!"
      
      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "âœ“ Build and Release Completed!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Version: ${{ steps.get_version.outputs.VERSION }}"
          Write-Host "Tag: ${{ github.ref_name }}"
          Write-Host "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          Write-Host ""

